<div class="transition duration-300">
  <main class="px-4 min-h-2/4 w-full m-auto mt-10">
    <!-- -----------------------FIRST CONTAINER------------------------------ -->
    <div class="flex justify-between my-4 text-xl tracking-wide w-3/5 mx-auto">
      <h2 class="font-extrabold uppercase text-[#052C13] drop-shadow-md">
        Usuarios
      </h2>
      <app-btn (click)="toggleAddUser()"> Alta usuario </app-btn>
    </div>

    <!-- -----------------------ADD MODAL------------------------------ -->
    <app-modal-wrapper
      [visible]="showAddUser"
      title="Crear nuevo usuario"
      (close)="toggleAddUser()"
    >
      <app-add-user #addUser (userAdded)="onUserAdded()"></app-add-user>
    </app-modal-wrapper>

    <!-- -----------------------FILTRO USUARIOS------------------------------ -->
    <div class="flex items-center mt-4 space-x-4 w-3/5 mx-auto">
      <!-- Selector de campo: Nombre / Email -->
      <mat-form-field
        appearance="fill"
        class="w-40"
        style="--mdc-filled-text-field-container-color: #fff"
      >
        <mat-label>Filtrar por:</mat-label>
        <mat-select
          [(value)]="filterField"
          (selectionChange)="onFilterFieldChange($event.value)"
        >
          <mat-option value="name">Nombre</mat-option>
          <mat-option value="email">Email</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Input de texto para buscar -->
      <mat-form-field
        appearance="fill"
        class="flex-grow"
        style="--mdc-filled-text-field-container-color: #fff"
      >
        <mat-label
          >Buscar
          {{
            filterField === "name"
              ? "Nombre"
              : filterField === "email"
              ? "Email"
              : ""
          }}</mat-label
        >
        <input
          matInput
          [(ngModel)]="filterValue"
          placeholder="Escribe para filtrar"
          (ngModelChange)="updatePaged()"
          [disabled]="!filterField"
        />
      </mat-form-field>

      <!-- Botón de limpiar filtro -->
      <button
        mat-icon-button
        class="hover:bg-gray-200 rounded-full transition"
        aria-label="Limpiar filtro"
        (click)="clearFilter()"
        *ngIf="filterField"
      >
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <!-- -----------------------USERS LIST------------------------------ -->
    <div
      class="relative overflow-x-auto shadow-lg rounded-2xl z-20 max-h-[600px] overflow-y-auto w-3/5 mx-auto"
    >
      <table class="table-fixed text-sm text-left rtl:text-right min-w-full">
        <thead class="text-white font-bold bg-dg tracking-wide">
          <tr>
            <th class="px-6 py-3 w-1/4">Nombre</th>
            <th class="px-6 py-3">Email</th>
            <th class="px-6 py-3">Roles</th>
            <th class="px-3 py-3">Activo</th>
            <th class="px-3 py-3 w-20">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Recorremos con índice -->
          <ng-container *ngFor="let user of pagedUsers; let i = index">
            <!-- Fila de datos -->
            <tr class="hover:bg-gray-50 border-b border-gray-200">
              <td class="px-6 py-4">{{ user.name }}</td>
              <td class="px-6 py-4">{{ user.email }}</td>
              <td class="px-6 py-4">
                <span *ngFor="let role of user.roles; let last = last">
                  {{ getRoleDisplayName(role) }}<span *ngIf="!last">, </span>
                </span>
              </td>

              <td class="px-3 py-4">
                <label class="inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    class="sr-only peer"
                    [checked]="user.active"
                    (change)="toggleUserActive(user)"
                  />
                  <div
                    class="relative w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-500 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-800"
                  ></div>
                </label>
              </td>

              <td
                class="px-3 py-4 space-x-2 inline-flex items-center justify-center"
              >
                <button
                  (click)="toggleEdit(i, user)"
                  matTooltip="Editar"
                  class="cursor-pointer"
                >
                  <mat-icon>edit</mat-icon>
                </button>

                <!-- <button
                  (click)="deleteUser(user.id!)"
                  matTooltip="Eliminar"
                  class="cursor-pointer"
                >
                  <mat-icon fontIcon="delete">delete</mat-icon>
                </button> -->
              </td>
            </tr>

            <!-- Fila con modal: solo si currentEditRow === i -->
            <tr *ngIf="currentEditRow === i">
              <td colspan="5" class="p-0 bg-transparent">
                <div class="p-4 bg-slate-100 rounded-b-2xl shadow-inner">
                  <app-modal-edit
                    [user]="editingUser!"
                    (save)="saveEdit($event)"
                    (cancel)="cancelEdit()"
                  ></app-modal-edit>
                </div>
              </td>
            </tr>
          </ng-container>

          <!-- Mensaje si no hay usuarios -->
          <tr *ngIf="pagedUsers.length === 0">
            <td
              colspan="5"
              class="p-4 text-center text-xl font-bold text-green-900"
            >
              No hay usuarios que mostrar
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- Paginación -->
    <mat-paginator
      class="w-3/5 mx-auto"
      [length]="users.length"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[10, 20, 50]"
      showFirstLastButtons
      (page)="onPage($event)"
    >
    </mat-paginator>
  </main>
</div>
